<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat en Tiempo Real</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #6366f1;
            --bg: #f0f0ff;
            --surface: #ffffff;
            --border: #e0e0f0;
            --text: #2d2d3f;
            --muted: #8b8ba7;
        }
        body {
            font-family: 'Nunito', sans-serif;
            background: var(--bg);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Login screen */
        .login-screen {
            width: 100%;
            max-width: 420px;
            padding: 20px;
        }
        .login-card {
            background: white;
            border-radius: 20px;
            padding: 36px 32px;
            box-shadow: 0 20px 60px rgba(99,102,241,0.15);
            text-align: center;
        }
        .login-emoji { font-size: 3rem; margin-bottom: 12px; }
        .login-title { font-size: 1.6rem; font-weight: 800; color: var(--text); margin-bottom: 6px; }
        .login-subtitle { color: var(--muted); font-size: 0.9rem; margin-bottom: 28px; }

        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-bottom: 24px;
        }
        .avatar-option {
            font-size: 1.6rem;
            padding: 8px;
            border-radius: 12px;
            cursor: pointer;
            border: 2px solid transparent;
            background: var(--bg);
            transition: all 0.2s;
            text-align: center;
        }
        .avatar-option.selected {
            border-color: var(--primary);
            background: #ede9fe;
            transform: scale(1.1);
        }
        .avatar-option:hover:not(.selected) { background: #ede9fe; }

        .color-row {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-bottom: 20px;
        }
        .color-btn {
            width: 28px; height: 28px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: transform 0.2s;
        }
        .color-btn.selected { border-color: #333; transform: scale(1.2); }

        .name-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-family: 'Nunito', sans-serif;
            font-size: 1rem;
            margin-bottom: 16px;
            text-align: center;
            font-weight: 600;
            transition: border-color 0.2s;
        }
        .name-input:focus { outline: none; border-color: var(--primary); }
        .btn-enter {
            width: 100%;
            padding: 13px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-family: 'Nunito', sans-serif;
            font-size: 1.05rem;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-enter:hover { background: #4f46e5; transform: translateY(-1px); }

        /* Chat screen */
        .chat-screen {
            display: none;
            width: 100%;
            max-width: 680px;
            height: 100vh;
            max-height: 700px;
            margin: 20px;
            flex-direction: column;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(99,102,241,0.15);
            overflow: hidden;
        }

        .chat-header {
            padding: 16px 20px;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .chat-header-left { display: flex; align-items: center; gap: 10px; }
        .chat-title { font-size: 1.1rem; font-weight: 800; }
        .online-count {
            background: rgba(255,255,255,0.2);
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.78rem;
            font-weight: 600;
        }
        .my-badge {
            background: rgba(255,255,255,0.15);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 700;
        }

        .firebase-warning {
            background: #fff7ed;
            border-bottom: 1px solid #fed7aa;
            padding: 8px 16px;
            font-size: 0.8rem;
            color: #c2410c;
            text-align: center;
        }

        .messages-area {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .messages-area::-webkit-scrollbar { width: 4px; }
        .messages-area::-webkit-scrollbar-track { background: transparent; }
        .messages-area::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

        .msg {
            display: flex;
            gap: 8px;
            animation: msgIn 0.3s ease;
            max-width: 100%;
        }
        .msg.mine { flex-direction: row-reverse; }

        .msg-avatar { font-size: 1.4rem; flex-shrink: 0; align-self: flex-end; }

        .msg-content {
            max-width: 72%;
        }
        .msg.mine .msg-content { align-items: flex-end; }

        .msg-name {
            font-size: 0.72rem;
            font-weight: 700;
            color: var(--muted);
            margin-bottom: 3px;
            padding: 0 4px;
        }
        .msg.mine .msg-name { text-align: right; }

        .msg-bubble {
            padding: 10px 14px;
            border-radius: 18px;
            font-size: 0.9rem;
            line-height: 1.4;
            word-break: break-word;
        }
        .msg .msg-bubble {
            background: #f0f0f8;
            border-radius: 4px 18px 18px 18px;
        }
        .msg.mine .msg-bubble {
            color: white;
            border-radius: 18px 4px 18px 18px;
        }

        .msg-time {
            font-size: 0.68rem;
            color: var(--muted);
            margin-top: 3px;
            padding: 0 4px;
        }
        .msg.mine .msg-time { text-align: right; }

        .day-divider {
            text-align: center;
            font-size: 0.72rem;
            color: var(--muted);
            font-weight: 600;
            margin: 8px 0;
        }

        .empty-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--muted);
            font-size: 0.9rem;
        }
        .empty-chat .big-emoji { font-size: 3rem; margin-bottom: 8px; }

        /* Input area */
        .input-area {
            padding: 12px 16px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 8px;
            align-items: flex-end;
            background: white;
        }
        .msg-input {
            flex: 1;
            padding: 10px 14px;
            border: 2px solid var(--border);
            border-radius: 20px;
            font-family: 'Nunito', sans-serif;
            font-size: 0.92rem;
            resize: none;
            max-height: 100px;
            transition: border-color 0.2s;
        }
        .msg-input:focus { outline: none; border-color: var(--primary); }
        .btn-send {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            font-size: 1.1rem;
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.2s;
        }
        .btn-send:hover { background: #4f46e5; transform: scale(1.05); }
        .btn-send:disabled { opacity: 0.5; }

        @keyframes msgIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #4ade80;
            border-radius: 50%;
            display: inline-block;
            animation: pulse 2s ease infinite;
        }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }
    </style>
</head>
<body>

    <!-- Login -->
    <div class="login-screen" id="loginScreen">
        <div class="login-card">
            <div class="login-emoji">üî•</div>
            <div class="login-title">Chat en Tiempo Real</div>
            <div class="login-subtitle">Elige tu avatar y nombre para comenzar</div>

            <div class="avatar-grid" id="avatarGrid">
                <div class="avatar-option selected" data-avatar="üòÄ" onclick="selectAvatar(this)">üòÄ</div>
                <div class="avatar-option" data-avatar="ü¶ä" onclick="selectAvatar(this)">ü¶ä</div>
                <div class="avatar-option" data-avatar="üê±" onclick="selectAvatar(this)">üê±</div>
                <div class="avatar-option" data-avatar="üê∂" onclick="selectAvatar(this)">üê∂</div>
                <div class="avatar-option" data-avatar="ü¶Å" onclick="selectAvatar(this)">ü¶Å</div>
                <div class="avatar-option" data-avatar="üêº" onclick="selectAvatar(this)">üêº</div>
                <div class="avatar-option" data-avatar="üê®" onclick="selectAvatar(this)">üê®</div>
                <div class="avatar-option" data-avatar="üê∏" onclick="selectAvatar(this)">üê∏</div>
                <div class="avatar-option" data-avatar="ü¶Ñ" onclick="selectAvatar(this)">ü¶Ñ</div>
                <div class="avatar-option" data-avatar="ü§ñ" onclick="selectAvatar(this)">ü§ñ</div>
            </div>

            <div class="color-row">
                <div class="color-btn selected" style="background:#6366f1" data-color="#6366f1" onclick="selectColor(this)"></div>
                <div class="color-btn" style="background:#ec4899" data-color="#ec4899" onclick="selectColor(this)"></div>
                <div class="color-btn" style="background:#10b981" data-color="#10b981" onclick="selectColor(this)"></div>
                <div class="color-btn" style="background:#f59e0b" data-color="#f59e0b" onclick="selectColor(this)"></div>
                <div class="color-btn" style="background:#ef4444" data-color="#ef4444" onclick="selectColor(this)"></div>
                <div class="color-btn" style="background:#0ea5e9" data-color="#0ea5e9" onclick="selectColor(this)"></div>
            </div>

            <input class="name-input" id="usernameLogin" placeholder="Tu nombre aqu√≠..." maxlength="20"
                onkeydown="if(event.key==='Enter') entrar()">
            <button class="btn-enter" onclick="entrar()">Entrar al Chat ‚Üí</button>
        </div>
    </div>

    <!-- Chat -->
    <div class="chat-screen" id="chatScreen">
        <div class="chat-header">
            <div class="chat-header-left">
                <span class="status-dot"></span>
                <div class="chat-title">üî• Chat en Tiempo Real</div>
                <div class="online-count" id="onlineCount">0 online</div>
            </div>
            <div class="my-badge" id="myBadge">‚Äî</div>
        </div>

        <div class="firebase-warning" id="fbWarning" style="display:none">
            ‚ö†Ô∏è Firebase no configurado. Los mensajes no se guardar√°n. Configura <code>firebase-credentials.json</code>
        </div>

        <div class="messages-area" id="messagesArea">
            <div class="empty-chat" id="emptyChat">
                <div class="big-emoji">üí¨</div>
                <p>No hay mensajes a√∫n. ¬°S√© el primero!</p>
            </div>
        </div>

        <div class="input-area">
            <textarea class="msg-input" id="msgInput" placeholder="Escribe un mensaje..."
                rows="1" maxlength="500"
                onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault();enviarMensaje()}"
                oninput="autoResize(this)"></textarea>
            <button class="btn-send" onclick="enviarMensaje()" id="btnSend">‚û§</button>
        </div>
    </div>

    <script>
        let currentUser = null, selectedAvatar = 'üòÄ', selectedColor = '#6366f1';
        let ultimoMsg = null, pollingInterval = null;

        function selectAvatar(el) {
            document.querySelectorAll('.avatar-option').forEach(a => a.classList.remove('selected'));
            el.classList.add('selected');
            selectedAvatar = el.dataset.avatar;
        }

        function selectColor(el) {
            document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('selected'));
            el.classList.add('selected');
            selectedColor = el.dataset.color;
        }

        async function entrar() {
            const nombre = document.getElementById('usernameLogin').value.trim();
            if (!nombre) { alert('Escribe tu nombre'); return; }
            currentUser = nombre;
            document.getElementById('loginScreen').style.display = 'none';
            const chat = document.getElementById('chatScreen');
            chat.style.display = 'flex';
            document.getElementById('myBadge').textContent = `${selectedAvatar} ${nombre}`;

            // Check Firebase
            const status = await fetch('/api/status').then(r => r.json());
            if (!status.firebase_ok) {
                document.getElementById('fbWarning').style.display = 'block';
            }

            cargarMensajes();
            pollingInterval = setInterval(cargarMensajes, 2500);
            setInterval(pingOnline, 10000);
            pingOnline();
        }

        let lastMsgIds = new Set();

        async function cargarMensajes() {
            try {
                const res = await fetch('/api/mensajes');
                const mensajes = await res.json();
                if (mensajes.error) return;
                if (mensajes.length === 0) return;

                const area = document.getElementById('messagesArea');
                const empty = document.getElementById('emptyChat');

                // Check for new messages
                const newMsgs = mensajes.filter(m => !lastMsgIds.has(m.id));
                if (newMsgs.length === 0) return;

                empty.style.display = 'none';
                if (lastMsgIds.size === 0) {
                    // First load - render all
                    area.innerHTML = '';
                    mensajes.forEach(m => area.appendChild(createMsgEl(m)));
                } else {
                    // Append new messages
                    newMsgs.forEach(m => area.appendChild(createMsgEl(m)));
                }
                mensajes.forEach(m => lastMsgIds.add(m.id));
                area.scrollTop = area.scrollHeight;
            } catch(e) {}
        }

        function createMsgEl(msg) {
            const isMine = msg.usuario === currentUser;
            const div = document.createElement('div');
            div.className = `msg${isMine ? ' mine' : ''}`;
            div.dataset.id = msg.id;

            const time = new Date(msg.timestamp).toLocaleTimeString('es-MX', {hour:'2-digit',minute:'2-digit'});
            const color = msg.color || '#6366f1';

            div.innerHTML = `
                <div class="msg-avatar">${msg.avatar || 'üë§'}</div>
                <div class="msg-content">
                    <div class="msg-name">${msg.usuario}</div>
                    <div class="msg-bubble" style="${isMine ? `background:${color}` : ''}">${escapeHtml(msg.texto)}</div>
                    <div class="msg-time">${time}</div>
                </div>
            `;
            return div;
        }

        async function enviarMensaje() {
            const input = document.getElementById('msgInput');
            const texto = input.value.trim();
            if (!texto || !currentUser) return;
            input.value = '';
            input.style.height = 'auto';
            document.getElementById('btnSend').disabled = true;

            try {
                const res = await fetch('/api/mensajes', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        usuario: currentUser,
                        texto,
                        avatar: selectedAvatar,
                        color: selectedColor
                    })
                });
                const data = await res.json();
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    cargarMensajes();
                }
            } catch(e) {}
            finally { document.getElementById('btnSend').disabled = false; }
        }

        async function pingOnline() {
            if (!currentUser) return;
            try {
                await fetch('/api/usuarios/ping', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({usuario: currentUser})
                });
                const res = await fetch('/api/usuarios/online');
                const online = await res.json();
                document.getElementById('onlineCount').textContent = `${online.length} online`;
            } catch(e) {}
        }

        function autoResize(el) {
            el.style.height = 'auto';
            el.style.height = Math.min(el.scrollHeight, 100) + 'px';
        }

        function escapeHtml(s) {
            return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
        }
    </script>
</body>
</html>
